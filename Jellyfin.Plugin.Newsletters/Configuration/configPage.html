<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Newsletters</title>
</head>
<body>
    <div id="NewsletterConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="NewsletterConfigForm">
                    <div id="OutboundEmailDetails">
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="DebugMode" name="DebugMode" type="checkbox" is="emby-checkbox" />
                                <span>Debug Mode</span>
                            </label>
                        </div>
                        <div class="inputContainer" id="ToAddress">
                            <label class="inputLabel inputLabelUnfocused" for="ToAddr">To Address:</label>
                            <input id="ToAddr" name="ToAddr" type="text" is="emby-input" />
                            <div class="fieldDescription">Recipient's email to recieve newsletter. If more than 1, seperate with commas</div>
                        </div>
                        <div class="inputContainer" id="FromAddress">
                            <label class="inputLabel inputLabelUnfocused" for="FromAddr">From Address:</label>
                            <input id="FromAddr" name="FromAddr" type="text" is="emby-input" />
                            <div class="fieldDescription">The address that the newsletter will come from</div>
                        </div>
                        <div class="inputContainer" id="SubjectTemplate">
                            <label class="inputLabel inputLabelUnfocused" for="Subject">Subject:</label>
                            <input id="Subject" name="Subject" type="text" is="emby-input" />
                            <div class="fieldDescription">Subject field of the newsletter (Default: 'Jellyfin Newsletter)</div>
                        </div>
                        <div class="inputContainer" id="BodyTemplate" style="display: none;">
                            <label class="inputLabel inputLabelUnfocused" for="Body">Body:</label>
                            <input id="Body" name="Body" type="text" is="emby-input" />
                            <div class="fieldDescription">Body of the email. Defaults to a predefined template</div>
                        </div>
                    </div>
                    <!-- Scraper configuration Details -->
                    <div id="HiddenDetails" name="ScraperConfig">
                        <details>
                            <summary>Scraper Config</summary>
                            <div class="inputContainer" id="MediaDirPath">
                                <label class="inputLabel inputLabelUnfocused" for="MediaDir" style="display: none;">Directory to Media:</label>
                                <input id="MediaDir" name="MediaDir" type="text" is="emby-input" />
                                <div class="fieldDescription">Currently only working for Series directories following the standard formatting: <i><b>/PATH/TO/My_Series/SeasonX/My_Series_S01E01.mp4</b></i></div>
                            </div>
                            <div class="inputContainer" id="GoogleAPIkey">
                                <label class="inputLabel inputLabelUnfocused" for="ApiKey">Imgur API Key:</label>
                                <input id="ApiKey" name="ApiKey" type="text" is="emby-input" />
                                <div class="fieldDescription">Required for image uploading so HTML formatting of newsletter can pull images (posters). Follow instructions <a href="https://dev.to/bearer/how-to-configure-the-imgur-api-2ap9" target="_blank">Here</a> and <a href="http://siberiancmscustomization.blogspot.com/2020/10/how-to-get-imgur-client-id.html" target="_blank">Here</a> </div>
                            </div>
                            <div class="inputContainer" id="GoogleCXkey">
                                <label class="inputLabel inputLabelUnfocused" for="CXKey" style="display: none;">Google CX Key:</label>
                                <input id="CXKey" name="CXKey" type="text" is="emby-input" />
                                <div class="fieldDescription">Required for image searching <b>(Different from API key above)</b>. Reference: <a href="https://stackoverflow.com/questions/6562125/getting-a-cx-id-for-custom-search-google-api-python" target="_blank">Google CX Key</a></div>
                            </div>
                        </details>
                    </div>
                    <br>
                    <!-- SMTP Server Details -->
                    <div id="HiddenDetails" name="ServerDetails">
                        <details>
                            <summary>SMTP Config</summary>
                            <div class="inputContainer" id="SMTPServerAddress">
                                <label class="inputLabel inputLabelUnfocused" for="SMTPServer">SMTP Server Address:</label>
                                <input id="SMTPServer" name="SMTPServerName" type="text" is="emby-input" />
                                <div class="fieldDescription">Server address of the SMTP server/service you want to use (i.e. smtp.gmail.com)</div>
                            </div>
                            <div class="inputContainer" id="SMTPPortNum">
                                <label class="inputLabel inputLabelUnfocused" for="SMTPPort">SMTP Port:</label>
                                <input id="SMTPPort" name="SMTPPortNum" type="number" is="emby-input" min="0" />
                                <div class="fieldDescription">SMTP Port that the server/service listed above uses (i.e. 587)</div>
                            </div>
                            <div class="inputContainer" id="SMTPUsername">
                                <label class="inputLabel inputLabelUnfocused" for="SMTPUser">SMTP Username:</label>
                                <input id="SMTPUser" name="SMTPUsername" type="text" is="emby-input" />
                                <div class="fieldDescription">Username/email that will be used to login to the SMTP server</div>
                            </div>
                            <div class="inputContainer" id="SMTPPassword">
                                <label class="inputLabel inputLabelUnfocused" for="SMTPPass">SMTP Password:</label>
                                <input id="SMTPPass" name="SMTPPassword" type="text" is="emby-input" />
                                <div class="fieldDescription">Password that will be used to login to the SMTP server</div>
                            </div>
                        </details>
                    </div>
                        <!-- buttons -->
                    <div>
                        <button id="testButton" is="emby-button" type="button" class="raised button-submit block emby-button" >
                            <span>Test Notifications</span>
                        </button>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <style>
            #HiddenDetails {
                border-width: 2px;
                border-style: solid;
                border-color: white;
                padding: 10px 10px 10px 10px;
            }
            #testButton {
                background: #C1C1BF;
                display: none;
            }
        </style>
        <script type="text/javascript">
            var NewsletterConfig = {
                pluginUniqueId: '60f478ab-2dd6-4ea0-af10-04d033f75979'
            };
            
            function saveConfig() {
                console.log("test");
                ApiClient.getPluginConfiguration(NewsletterConfig.pluginUniqueId).then(function (config) {
                    config.DebugMode = document.querySelector('#DebugMode').checked;
                    //serverDetails
                    config.SMTPServer = document.querySelector('#SMTPServer').value;
                    config.SMTPPort = document.querySelector('#SMTPPort').value;
                    config.SMTPUser = document.querySelector('#SMTPUser').value;
                    config.SMTPPass = document.querySelector('#SMTPPass').value;
                    //emailDetails
                    config.ToAddr = document.querySelector('#ToAddr').value;
                    config.FromAddr = document.querySelector('#FromAddr').value;
                    config.Subject = document.querySelector('#Subject').value;
                    config.Body = document.querySelector('#Body').value;
                    //scraperConfig
                    config.MediaDir = document.querySelector('#MediaDir').value;
                    config.ApiKey = document.querySelector('#ApiKey').value;
                    config.CXKey = document.querySelector('#CXKey').value;
                    // console.log("HERE: ",config);

                    ApiClient.updatePluginConfiguration(NewsletterConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                        console.log("RESULT: ", result);
                    });
                });

            }

            function loadConfig() {
                ApiClient.getPluginConfiguration(NewsletterConfig.pluginUniqueId).then(function (config) {
                    console.log("Populating Page..");
                    document.querySelector('#DebugMode').checked = config.DebugMode;
                    //serverDetails
                    document.querySelector('#SMTPServer').value = config.SMTPServer;
                    document.querySelector('#SMTPPort').value = config.SMTPPort;
                    document.querySelector('#SMTPUser').value = config.SMTPUser;
                    document.querySelector('#SMTPPass').value = config.SMTPPass;
                    //emailDetails
                    document.querySelector('#ToAddr').value = config.ToAddr;
                    document.querySelector('#FromAddr').value = config.FromAddr;
                    document.querySelector('#Subject').value = config.Subject;
                    document.querySelector('#Body').value = config.Body;
                    //scraperConfig
                    document.querySelector('#MediaDir').value = config.MediaDir;
                    document.querySelector('#ApiKey').value = config.ApiKey;
                    document.querySelector('#CXKey').value = config.CXKey;
                    Dashboard.hideLoadingMsg();
                });

            }

            document.querySelector('#NewsletterConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    loadConfig();
                });

            document.querySelector('#NewsletterConfigForm')
                .addEventListener('submit', function(e) {
                Dashboard.showLoadingMsg();
                saveConfig();

                e.preventDefault();
                return false;
            });

            document.querySelector('#testButton')
                .addEventListener('click', function(e) {
                Dashboard.showLoadingMsg();
                saveConfig();
                console.log("TestButtonPressed!");
                // Configure test notification
                ApiClient.getPluginConfiguration(NewsletterConfig.pluginUniqueId).then(function (config) {
                    console.log("TEST: ", config);
                    let url = ApiClient.getUrl('Smtp/SendSmtp');
                    console.log("ServerAddr: ", ApiClient.serverAddress());
                    //let url = '@Url.Action("SendSmtp", "Home")';
                    //let url = '<%= ResolveUrl("/home/christopher/Development/jellyfin-plugins/newsletters/Jellyfin.Plugin.Newsletters/Scripts/smtp.cs") %>';
                    console.log("URL: ",url);
                    let data = JSON.stringify(config);
                    ApiClient.ajax({ type: 'POST', url, data, contentType: 'application/json' });
                    //Jellyfin.Plugin.NewsLetters.Scripts.Smtp.SendSmtp("test", "test2") ;
                    //Blazor.platform.callMethod(sendSmtp, null);
                });


                

                e.preventDefault();
                return false;
            });

        </script>
    </div>
</body>
</html>
