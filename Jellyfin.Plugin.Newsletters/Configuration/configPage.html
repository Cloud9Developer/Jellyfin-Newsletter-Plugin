<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Newsletters</title>
</head>
<body>
    <div id="NewsletterConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="NewsletterConfigForm">
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="DebugMode" name="DebugMode" type="checkbox" is="emby-checkbox" />
                            <span>Debug Mode</span>
                        </label>
                    </div>
                    <div id="OutboundEmailDetails">
                        <div class="inputContainer" id="ToAddress">
                            <label class="inputLabel inputLabelUnfocused" for="ToAddr">To Address:</label>
                            <input id="ToAddr" name="ToAddr" type="text" is="emby-input" />
                            <div class="fieldDescription">Recipient's email to recieve newsletter. If more than 1, seperate with commas</div>
                        </div>
                        <div class="inputContainer" id="FromAddress">
                            <label class="inputLabel inputLabelUnfocused" for="FromAddr">From Address:</label>
                            <input id="FromAddr" name="FromAddr" type="text" is="emby-input" />
                            <div class="fieldDescription">The address that the newsletter will come from</div>
                        </div>
                        <div class="inputContainer" id="SubjectTemplate">
                            <label class="inputLabel inputLabelUnfocused" for="Subject">Subject:</label>
                            <input id="Subject" name="Subject" type="text" is="emby-input" />
                            <div class="fieldDescription">Subject field of the newsletter (Default: 'Jellyfin Newsletter)</div>
                        </div>
                    </div>
                    <div id="LibrarySelection">
                        <table>
                            <th>Types of items to scan:</th>
                            <tr>
                                <td>
                                    <div class="checkboxContainer checkboxContainer-withDescription">
                                        <label class="emby-checkbox-label">
                                            <input id="SeriesEnabled" name="SeriesEnabled" type="checkbox" is="emby-checkbox" />
                                            <span>Series</span>
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <div class="checkboxContainer checkboxContainer-withDescription">
                                        <label class="emby-checkbox-label">
                                            <input id="MoviesEnabled" name="MoviesEnabled" type="checkbox" is="emby-checkbox" />
                                            <span>Movies</span>
                                        </label>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- <div class="inputContainer" id="BodyTemplate" style="display: none;"> -->
                    <!-- Newsletter Formatting -->
                    <!-- Main Body -->
                    <div id="HiddenDetails" name="HtmlFormatting" class="DropdownSection">
                        <details>
                            <summary>Newsletter HTML Format</summary><br>
                            <div class="inputContainer" id="BodyTemplate">
                                <label class="inputLabel inputLabelUnfocused" for="Body">Body Html:</label>
                                <div class="fieldDescription">
                                    See below for Field Names to use in your custom HTML:<br>
                                    {Date} - The date of Newsletter generation. <br>
                                    {EntryData} - This is the insert of the custom HTML from the field EntryData below. If not used, email will have no data. <br>
                                </div>
                                <textarea id="Body" name="Body" dataname="Body" style="width: 100%; height: 400px"></textarea>
                                <div class="fieldDescription">HTML formatting for main Body of email. Defaults to a predefined template</div>
                            </div>
                            <!-- Entry/Cell Data -->
                            <div class="inputContainer" id="EntryTemplate">
                                <label class="inputLabel inputLabelUnfocused" for="Entry">EntryData Html:</label>
                                <div class="fieldDescription">
                                    See below for Field Names to use in your custom HTML:<br>
                                    {ImageURL} - The physical URL for the image to be used. For HTML formatting, should be used within a 'img' tag as it's source. <br>
                                    {Title} - Title of the Series/Movie for the entry <br>
                                    {SeasonEpsInfo} - Season-Episode information for a series (Doesn't show for movies) <br>
                                    {SeriesOverview} - The series/movie overview <br>
                                </div>
                                <textarea id="Entry" name="Entry" dataname="Entry" style="width: 100%; height: 400px"></textarea>
                                <div class="fieldDescription">Html formatting for each Entry (episode, movie, etc.) for the email. Defaults to a predefined template</div>
                            </div>
                        </details>
                    </div>
                    <br>

                    <!-- Scraper configuration Details -->
                    <div id="HiddenDetails" name="ScraperConfig" class="DropdownSection">
                        <details>
                            <summary>Scraper Config</summary><br>
                            <div class="selectContainer">
                                <label class="selectLabel" for="HostingSelector">Poster Hosting Type:</label>
                                <select is="emby-select" id="HostingSelector" name="HostingSelector" class="emby-select-withcolor emby-select">
                                    <option id="defaultImgur" value="Imgur">Imgur (Default)</option>
                                    <option id="localJFHosting" value="JfHosting">Local JF Hosting</option>
                                    <option id="embedded" value="Embedded">Embedded</option>
                                </select>
                            </div>
                            <hr>
                            <div id="Imgur" name="options">
                                <div class="inputContainer" id="ImgurClientID">
                                    <label class="inputLabel inputLabelUnfocused" for="ApiKey">Imgur API Key:</label>
                                    <input id="ApiKey" name="ApiKey" type="text" is="emby-input" />
                                    <div class="fieldDescription">Required for image uploading so HTML formatting of newsletter can pull images (posters). Follow instructions <a href="https://dev.to/bearer/how-to-configure-the-imgur-api-2ap9" target="_blank">Here</a> and <a href="http://siberiancmscustomization.blogspot.com/2020/10/how-to-get-imgur-client-id.html" target="_blank">Here</a> </div>
                                </div>
                            </div>
                            <div id="JfHosting" name="options">
                                <div class="inputContainer" id="LocalHostname">
                                    <label class="inputLabel inputLabelUnfocused" for="ApiKey">Hostname:</label>
                                    <input id="Hostname" name="Hostname" type="text" is="emby-input" />
                                    <div class="fieldDescription">
                                        Hostname for your JF server that is accessible from outside your network. Ensure to include http[s]:// and port number (if applicable). <b>DO NOT include a trailing slash '/'</b>. 
                                        <br><br>
                                        I.e: https://myServerDNSName.com:8096
                                    </div>
                                </div>
                            </div>
                            <div id="Embedded" name="options">
                            </div>
                        </details>
                    </div>

                    <br>
                    <!-- SMTP Server Details -->
                    <div id="HiddenDetails" name="ServerDetails" class="DropdownSection">
                        <details>
                            <summary>SMTP Config</summary><br>
                            <div class="inputContainer" id="SMTPServerAddress">
                                <label class="inputLabel inputLabelUnfocused" for="SMTPServer">SMTP Server Address:</label>
                                <input id="SMTPServer" name="SMTPServerName" type="text" is="emby-input" />
                                <div class="fieldDescription">Server address of the SMTP server/service you want to use (i.e. smtp.gmail.com)</div>
                            </div>
                            <div class="inputContainer" id="SMTPPortNum">
                                <label class="inputLabel inputLabelUnfocused" for="SMTPPort">SMTP Port:</label>
                                <input id="SMTPPort" name="SMTPPortNum" type="number" is="emby-input" min="0" />
                                <div class="fieldDescription">SMTP Port that the server/service listed above uses (i.e. 587)</div>
                            </div>
                            <div class="inputContainer" id="SMTPUsername">
                                <label class="inputLabel inputLabelUnfocused" for="SMTPUser">SMTP Username:</label>
                                <input id="SMTPUser" name="SMTPUsername" type="text" is="emby-input" />
                                <div class="fieldDescription">Username/email that will be used to login to the SMTP server</div>
                            </div>
                            <div class="inputContainer" id="SMTPPassword">
                                <label class="inputLabel inputLabelUnfocused" for="SMTPPass">SMTP Password:</label>
                                <input id="SMTPPass" name="SMTPPassword" type="text" is="emby-input" />
                                <div class="fieldDescription">Password that will be used to login to the SMTP server</div>
                            </div>
                            <button id="testButton" is="emby-button" type="button" class="raised block emby-button">
                                <span>Test</span>
                            </button>
                        </details>
                    </div>
                        <!-- buttons -->
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <style>
            #HiddenDetails {
                border-width: 2px;
                border-style: solid;
                border-color: white;
                padding: 10px 10px 10px 10px;
            }
            #testButton {
                background: #C1C1BF;
            }
            td {
                padding-right: 10px;
            }
            .DropdownSection {
                cursor: pointer;
            }
        </style>
        <script type="text/javascript">
            var NewsletterConfig = {
                pluginUniqueId: '60f478ab-2dd6-4ea0-af10-04d033f75979'
            };

            function hideScraperConfig() {
                let options = document.getElementsByName("options");
                options.forEach((option) => {
                    option.style.display = 'none';
                });
            }

            function showScraperConfig(id) {
                document.getElementById(id).style.display = 'block';
            }
            
            function saveConfig() {
                //console.log("test");
                ApiClient.getPluginConfiguration(NewsletterConfig.pluginUniqueId).then(function (config) {
                    config.DebugMode = document.querySelector('#DebugMode').checked;
                    //serverDetails
                    config.SMTPServer = document.querySelector('#SMTPServer').value;
                    config.SMTPPort = document.querySelector('#SMTPPort').value;
                    config.SMTPUser = document.querySelector('#SMTPUser').value;
                    config.SMTPPass = document.querySelector('#SMTPPass').value;
                    //emailDetails
                    config.ToAddr = document.querySelector('#ToAddr').value;
                    config.FromAddr = document.querySelector('#FromAddr').value;
                    config.Subject = document.querySelector('#Subject').value;
                    //emailHtmlFormatting
                    config.Body = document.querySelector('#Body').value;
                    config.Entry = document.querySelector('#Entry').value;
                    //librariesEnabled
                    config.SeriesEnabled = document.querySelector('#SeriesEnabled').checked;
                    config.MoviesEnabled = document.querySelector('#MoviesEnabled').checked;
                    //scraperConfig
                    //hosting options
                    config.PHType = document.querySelector('#HostingSelector').value;
                    config.ApiKey = document.querySelector('#ApiKey').value;
                    config.Hostname = document.querySelector('#Hostname').value;

                    ApiClient.updatePluginConfiguration(NewsletterConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                        console.log("RESULT: ", result);
                    });
                });

            }

            function loadConfig() {
                ApiClient.getPluginConfiguration(NewsletterConfig.pluginUniqueId).then(function (config) {
                    console.log("Populating Page..");
                    document.querySelector('#DebugMode').checked = config.DebugMode;
                    //serverDetails
                    document.querySelector('#SMTPServer').value = config.SMTPServer;
                    document.querySelector('#SMTPPort').value = config.SMTPPort;
                    document.querySelector('#SMTPUser').value = config.SMTPUser;
                    document.querySelector('#SMTPPass').value = config.SMTPPass;
                    //emailDetails
                    document.querySelector('#ToAddr').value = config.ToAddr;
                    document.querySelector('#FromAddr').value = config.FromAddr;
                    document.querySelector('#Subject').value = config.Subject;
                    //emailHtmlFormatting
                    document.querySelector('#Body').value = config.Body;
                    document.querySelector('#Entry').value = config.Entry;
                    //librariesEnabled
                    document.querySelector('#SeriesEnabled').checked = config.SeriesEnabled;
                    document.querySelector('#MoviesEnabled').checked = config.MoviesEnabled;
                    //scraperConfig
                    //hosting options
                    document.querySelector('#HostingSelector').value = config.PHType;
                    hideScraperConfig();
                    showScraperConfig(config.PHType);
                    document.querySelector('#ApiKey').value = config.ApiKey;
                    document.querySelector('#Hostname').value = config.Hostname;

                    Dashboard.hideLoadingMsg();
                });

            }

            document.querySelector('#NewsletterConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    loadConfig();
                });

            document.querySelector('#NewsletterConfigForm')
                .addEventListener('submit', function(e) {
                Dashboard.showLoadingMsg();
                saveConfig();

                e.preventDefault();
                return false;
            });

            // button to test SMTP configration
            document.querySelector('#testButton')
                .addEventListener('click', function(e) {
                Dashboard.showLoadingMsg();
                // saveConfig();
                console.log("Test mail button pressed!");
                // Configure test notification
                ApiClient.getPluginConfiguration(NewsletterConfig.pluginUniqueId).then(function (config) {
                    console.log("TEST: ", config);
                    let url = ApiClient.getUrl('Smtp/SendTestMail');
                    console.log("ServerAddr: ", ApiClient.serverAddress());
                    console.log("URL: ",url);
                    let data = JSON.stringify(config);
                    ApiClient.ajax({ type: 'POST', url, data, contentType: 'application/json' });
                });
                Dashboard.hideLoadingMsg();
                e.preventDefault();
                alert("Test email sent!");
                return false;
            });

            document.querySelector('#HostingSelector')
                .addEventListener('change', function() {
                hideScraperConfig();
                showScraperConfig(this.value);
            });

        </script>
    </div>
</body>
</html>
